@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.ApplicationConfig
@import models.Leaving
@import views.ViewHelpers
@import uk.gov.hmrc.govukfrontend.views.html.components._


@this(
        gmpMain: gmp_main,
        viewHelpers: ViewHelpers,
        govukRadios : GovukRadios,
        govukButton: GovukButton,
        govukDateInput: GovukDateInput,
        govukErrorMessage: GovukErrorMessage,
        govukErrorSummary: GovukErrorSummary,
        govukBackLink : GovukBackLink)


@(dateOfLeavingForm: Form[models.Leaving],scenario: String)(implicit request: Request[_], messages: Messages, applicationConfig: ApplicationConfig)
@inputHasErrors(input: String) = @{input match {
    case i: String if dateOfLeavingForm.hasErrors && dateOfLeavingForm.errors.head.toString.contains(i) => true
    case i: String if dateOfLeavingForm.hasErrors && dateOfLeavingForm.errors.head.toString.contains("Enter a leaving date") => true
    case _ => false
}}

@conditionalHtml = {
@govukDateInput(DateInput(
    id = "leavingDate",
    hint = Some(Hint(
        content = Text(Messages("gmp.date.example"))
    )),
    errorMessage = dateOfLeavingForm.errors.headOption.map(e => ErrorMessage(content = Text(messages(e.message, e.args:_*)))),
    items = Seq(
        InputItem(name = "leavingDate.day", classes = s"govuk-input--width-2 ${if(inputHasErrors("day")){" govuk-input--error"} else {""}}", label=Some("Day"), value = dateOfLeavingForm.data.get("leavingDate.day")),
        InputItem(name = "leavingDate.month", classes = s"govuk-input--width-2${if(inputHasErrors("month")){" govuk-input--error"} else {""}}", label=Some("Month"), value = dateOfLeavingForm.data.get("leavingDate.month")),
        InputItem(name = "leavingDate.year", classes = s"govuk-input--width-4${if(inputHasErrors("year")){" govuk-input--error"} else {""}}", label=Some("Year"), value = dateOfLeavingForm.data.get("leavingDate.year"))),
    fieldset = Some(Fieldset(
        legend = Some(Legend(
            content = Text(Messages("gmp.date.header_text")),
            classes = "govuk-fieldset__legend--m",
            isPageHeading = false
        ))
    ))
))
}

@heading = {
@{scenario match {
    case CalculationType.DOL => Messages("gmp.leaving.dol.question")
    case CalculationType.SPA | CalculationType.PAYABLE_AGE | CalculationType.REVALUATION => Messages("gmp.other.dol.left.question")
    case CalculationType.SURVIVOR => Messages("gmp.survivor.dol.question")}
}
}

@gmpMain(title = heading + " - " + Messages("service.title") + " - " + Messages("gov.uk")) {

    @govukBackLink(BackLink(
        href = controllers.routes.DateOfLeavingController.back.url,
        content = Text("Back")
    ))

    @if(dateOfLeavingForm.errors.nonEmpty) {
        @govukErrorSummary(ErrorSummary(errorList = Seq(ErrorLink(
            href = Some(s"#${if (dateOfLeavingForm.errors.head.key.contains("leaving") && dateOfLeavingForm.data.get("leaving").equals("yes-after")) dateOfLeavingForm.errors.head.key else s"leavingDate-leavingDate.day" }"),
            content = Text(s"${messages(s"${dateOfLeavingForm.errors.head.message}")}"),
        )), title = Text(messages("generic.errorSummary"))))
    }

    @viewHelpers.form(action = routes.DateOfLeavingController.post) {
        @if(scenario == CalculationType.DOL) {
            @govukRadios(Radios(
                fieldset = Some(Fieldset(
                    legend = Some(Legend(
                        content = Text(Messages("gmp.leaving.dol.question")),
                        classes = "govuk-fieldset__legend--l",
                        isPageHeading = true
                    ))
                )),
                idPrefix = Some("leaving"),
                name = "leaving",
                errorMessage = if (dateOfLeavingForm.hasErrors && dateOfLeavingForm.errors.head.key == "leaving") {
                    Some(ErrorMessage(content = Text(s"${dateOfLeavingForm.errors.head.message}")))
                } else None,
                items = Seq(
                    RadioItem(
                        content = Text(Messages("gmp.generic.yes")),
                        value = Some(Leaving.YES_BEFORE),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_BEFORE)
                    ),
                    RadioItem(
                        content = Text(Messages("gmp.generic.no")),
                        value = Some(Leaving.YES_AFTER),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_AFTER),
                        conditionalHtml = Some(conditionalHtml)
                    )
                )
            ))

        } else { @if(scenario == CalculationType.SURVIVOR) {
            @govukRadios(Radios(
                fieldset = Some(Fieldset(
                    legend = Some(Legend(
                        content = Text(Messages("gmp.survivor.dol.question")),
                        classes = "govuk-fieldset__legend--l",
                        isPageHeading = true
                    ))
                )),
                idPrefix = Some("leaving"),
                name = "leaving",
                errorMessage = if (dateOfLeavingForm.hasErrors && dateOfLeavingForm.errors.head.key == "leaving") {
                    Some(ErrorMessage(content = Text(s"${dateOfLeavingForm.errors.head.message}")))
                } else None,
                items = Seq(
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.no.survivor")),
                        value = Some(Leaving.NO),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.NO)
                    ),
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.before2016")),
                        value = Some(Leaving.YES_BEFORE),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_BEFORE)
                    ),
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.after2016")),
                        value = Some(Leaving.YES_AFTER),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_AFTER),
                        conditionalHtml = Some(conditionalHtml)
                    )
                )
            ))
        } else {
            @govukRadios(Radios(
                fieldset = Some(Fieldset(
                    legend = Some(Legend(
                        content = Text(Messages("gmp.other.dol.left.question")),
                        classes = "govuk-fieldset__legend--l",
                        isPageHeading = true
                    ))
                )),
                idPrefix = Some("leaving"),
                name = "leaving",
                errorMessage = if (dateOfLeavingForm.hasErrors && dateOfLeavingForm.errors.head.key == "leaving") {
                    Some(ErrorMessage(content = Text(s"${dateOfLeavingForm.errors.head.message}")))
                } else None,
                items = Seq(
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.no")),
                        value = Some(Leaving.NO),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.NO)
                    ),
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.before2016")),
                        value = Some(Leaving.YES_BEFORE),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_BEFORE)
                    ),
                    RadioItem(
                        content = Text(Messages("gmp.dol.threequestions.after2016")),
                        value = Some(Leaving.YES_AFTER),
                        checked = dateOfLeavingForm.data.values.toList.contains(Leaving.YES_AFTER),
                        conditionalHtml = Some(conditionalHtml)
                    )
                ),
            ))

        }
        }

        @govukButton(Button(content = Text(messages("gmp.continue.button"))))

    }
}
