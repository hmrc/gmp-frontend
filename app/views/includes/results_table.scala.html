@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.govukfrontend.views.html.components._
@(calculationResponse:CalculationResponse, govukTable : GovukTable)(implicit messages: Messages)

@import java.time.LocalDate
@import java.time.format.DateTimeFormatter

@dateFormatter = @{DateTimeFormatter.ofPattern("d MMM yyyy")}


@heading1 = @{
    if(calculationResponse.calcType == CalculationType.SURVIVOR.toInt) s"${Messages("gmp.total.entitlement")} £${calculationResponse.totalGmp}"
     else s"${Messages("gmp.total")}<br>£${calculationResponse.totalGmp}"
    }

@heading2 = @{
    if(calculationResponse.calcType == CalculationType.SURVIVOR.toInt) s"${Messages("gmp.post88.entitlement")} £${calculationResponse.post88Gmp}"
    else s"${Messages("gmp.post.1988")}<br>£${calculationResponse.post88Gmp}"
}


@content(count: Int, period: CalculationPeriod) = @{
    if(count == 0 && !period.endDate.isBefore(LocalDate.now)) s"--"
    else Messages(s"gmp.revaluation_rate.type_${period.revaluationRate}")
}

@htmlContent1(period: CalculationPeriod) = @{
    if(period.dualCalcPost90TrueTotal != Some("0.00"))
        s"£${period.dualCalcPost90TrueTotal.getOrElse("--")}<br>${Messages("gmp.frequency.weekly")}" else
        s"--"
}
@htmlContent2(period: CalculationPeriod) = @{
    if(period.dualCalcPost90OppositeTotal != Some("0.00"))
        s"£${period.dualCalcPost90OppositeTotal.getOrElse("--")}<br>${Messages("gmp.frequency.weekly")}" else
        s"--"
}



@govukTable(Table(
    rows = calculationResponse.calculationPeriods.zipWithIndex.map { result =>
        val (period, count) = result

        val currentDate = period.startDate.get.format(dateFormatter)
        val endDate = period.endDate.format(dateFormatter)
        Seq(
            TableRow(
                content = HtmlContent(s"<b>$currentDate</b> ${Messages("gmp.date_to")} <b>$endDate</b>")
            ),
            TableRow(
                content = HtmlContent(s"£${period.gmpTotal}<br>${Messages("gmp.frequency.weekly")}")
            ),
            TableRow(
                content = HtmlContent(s"£${period.post88GMPTotal}<br>${Messages("gmp.frequency.weekly")}")
            ),
            if(calculationResponse.showRateColumn){
                TableRow(
                    content = Text(Messages(s"gmp.revaluation_rate.type_${period.revaluationRate}"))
                )
            } else TableRow()
        )
    }
    ,
    head = Some(Seq(
        HeadCell(
            content = Text(Messages("gmp.table.period")),
            classes = "govuk-!-width-one-half"
        ),
        HeadCell(
            content = HtmlContent(heading1),
            classes = "govuk-!-width-one-quarter"
        ),
        HeadCell(
            content = HtmlContent(heading2),
            classes = "govuk-!-width-one-quarter"
        ),
        if(calculationResponse.showRateColumn){
            HeadCell(
                content = Text( Messages("gmp.rate")),
                classes = "govuk-!-width-one-quarter"
            )
        } else HeadCell()

    )),
    captionClasses = "govuk-table__caption--m",
    firstCellIsHeader = false,
    caption = None,
))

@if(calculationResponse.dualCalc){

    @govukTable(Table(
        rows = calculationResponse.calculationPeriods.zipWithIndex.map { result =>
            val (period, count) = result

            val currentDate = period.startDate.get.format(dateFormatter)
            val endDate = period.endDate.format(dateFormatter)
            Seq(
                TableRow(
                    content = HtmlContent(s"<b>$currentDate</b> ${Messages("gmp.date_to")} <b>$endDate</b>")
                ),
                TableRow(
                    content = HtmlContent(htmlContent1(period))
                ),
                TableRow(
                    content = HtmlContent(htmlContent2(period))
                ),
                if(calculationResponse.showRateColumn){
                    TableRow(
                        content = Text(content(count, period))
                    )
                } else TableRow()
            )
        }
        ,
        head = Some(Seq(
            HeadCell(
                content = Text(Messages("gmp.table.period")),
                classes  = "app-custom-class"
            ),
            HeadCell(
                content = HtmlContent(s"${Messages("gmp.post90.true")}<br>£${calculationResponse.trueCalculation}"),
                classes = "app-custom-class"
            ),
            HeadCell(
                content = HtmlContent(s"${Messages("gmp.post90.opposite")}<br>£${calculationResponse.oppositeCalculation}"),
                classes = "app-custom-class"
            ),
            if(calculationResponse.showRateColumn){
                HeadCell(
                    content = Text( Messages("gmp.rate")),
                    classes = "app-custom-class"
                )
            } else HeadCell()

        )),
        captionClasses = "govuk-table__caption--m",
        firstCellIsHeader = false,
        caption = Some(Messages("gmp.multi.dual_calc.header")),

    ))

}
